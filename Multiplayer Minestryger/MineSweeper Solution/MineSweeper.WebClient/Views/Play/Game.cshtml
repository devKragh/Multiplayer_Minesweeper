<script src="~/Scripts/jquery-1.10.2.js" type="text/javascript"></script>
<script src="~/Scripts/LoadGameData.js" type="text/javascript"></script>

<!--Reference the jQuery library. -->
<script src="~/Scripts/jquery-1.10.2.min.js"></script>
<!--Reference the SignalR library. -->
<script src="~/Scripts/jquery.signalR-2.2.2.min.js"></script>
<!--Reference the autogenerated SignalR hub script. -->
<script src="~/signalr/hubs"></script>

<head>
	<link href="~/Content/GameStyle.css" rel="stylesheet" />
	<script type="text/javascript">
		var firstRun = true;
		var gamedata;
		var gameHub;
		var localPlayer = "@Request.Cookies.Get("Session")["name"]";
		$(document).ready(function () {
			gameHub = $.connection.playHub;

			gameHub.client.updateGameData = function (gameBoard) {
				console.log("Update game is being called from server");
				if (firstRun) {
					firstRun = false;
					console.log("this is first run");
					BuildBoard(gameBoard);
				}
				gamedata = gameBoard;
				UpdateBoard(gameBoard, localPlayer);
			};

			gameHub.client.callOnEndGame = function () {
				CallOnEndGame(gamedata);
				UpdateBoard(gamedata);
			}

			setTimeout(function () {
				$.connection.hub.logging = true;
				$.connection.hub.start({ transport: 'webSockets' }).done(function () {
					console.log("Connected, Transport: " + $.connection.hub.transport.name);
					JoinGame();
				});

			}, 3000)

		});

		function MakeMove(button) {
			console.log("Making Move")
			var buttonId = button.id;
			var xny = button.id.split("_");
			console.log(xny[0] + xny[1]);
			var x = xny[0];
			var y = xny[1];
			gameHub.server.tryActivateField(buttonId, @Request.Cookies.Get("Session")["id"], "@Request.Cookies.Get("Session")["key"]").fail(function (error) {
			alert(error);
			});
		}

		function JoinGame(){
			console.log("Joined game");
			gameHub.server.joinGame(@Request.Cookies.Get("Session")["id"], "@Request.Cookies.Get("Session")["key"]").done(document.getElementById("status").innerHTML = "Connected").fail(function (error) {
					alert(error);
				})
			}
	</script>
</head>

<body>
	<div id="gameMenuButtons">
		<h3>Game Menu Buttons</h3>
		<h4 id="status">Loading...</h4>
		<button onclick="location.href='@Url.Action("Index", "Play")'" id="ToIndex">Go back</button>
		@*<button id="surrenderNewgame" onclick="JoinGame()">Join A game</button>*@
	</div>

	<div>
		<div id="game"></div>
		<div id="players"></div>
	</div>
</body>